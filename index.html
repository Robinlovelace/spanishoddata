<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Get Spanish Origin-Destination Data • spanishoddata</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Get Spanish Origin-Destination Data">
<meta name="description" content="Enables access to origin-destination (OD) provided by the Spanish Minstry of Transport, hosted at &lt;https://www.transportes.gob.es/ministerio/proyectos-singulares/estudios-de-movilidad-con-big-data/opendata-movilidad&gt;. It contains functions for downloading zone boundaries and associated origin-destination data. The OD datasets are large. The package eases working with them by using the database interface package duckdb, using an optional environment variable SPANISH_OD_DATA_DIR to avoid repeated downloads, and by providing documentation demonstrating how to collect subsets of the resulting databases into memory.">
<meta property="og:description" content="Enables access to origin-destination (OD) provided by the Spanish Minstry of Transport, hosted at &lt;https://www.transportes.gob.es/ministerio/proyectos-singulares/estudios-de-movilidad-con-big-data/opendata-movilidad&gt;. It contains functions for downloading zone boundaries and associated origin-destination data. The OD datasets are large. The package eases working with them by using the database interface package duckdb, using an optional environment variable SPANISH_OD_DATA_DIR to avoid repeated downloads, and by providing documentation demonstrating how to collect subsets of the resulting databases into memory.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">spanishoddata</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/uses.html">Use cases</a></li>
    <li><a class="dropdown-item" href="articles/work-with-v1-data.html">Working with v1 MITMA data</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Robinlovelace/spanishoddata/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9">
<p><strong>spanishoddata</strong> is an R package that provides functions for downloading and formatting Spanish origin-destination (OD) data from the Ministry of Transport and Sustainable Mobility of Spain.</p>
<p>It supports the two versions of the Spanish OD data. <a href="https://www.transportes.gob.es/ministerio/proyectos-singulares/estudios-de-movilidad-con-big-data/estudios-de-movilidad-anteriores/covid-19/opendata-movilidad" class="external-link">The first version</a> covers data from 2020 and 2021, including the period of the COVID-19 pandemic. <a href="https://www.transportes.gob.es/ministerio/proyectos-singulares/estudios-de-movilidad-con-big-data/opendata-movilidad" class="external-link">The second version</a> contains data from January 2022 onwards and is updated monthly on the fifteenth of each month. Both versions of the data primarily consist of mobile phone positioning data, and include matrices for overnight stays, individual movements, and trips of Spanish residents at different geographical levels.</p>
<p><strong>spanishoddata</strong> is designed to save people time by providing the data in analysis-ready formats. Automating the process of downloading, cleaning, and importing the data can also reduce the risk of errors in the laborious process of data preparation. It also reduces computational resources by using computationally efficient packages behind the scenes. To effectively work with multiple data files, it’s recommended you set up a data directory where the package can search for the data and download only the files that are not already present.</p>
<div class="section level1">
<div class="page-header"><h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h1></div>
<p>Install the package as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://remotes.r-lib.org" class="external-link">"remotes"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"Robinlovelace/spanishoddata"</span><span class="op">)</span></span></code></pre></div>
<p>Load it as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://robinlovelace.github.io/spanishoddata/" class="external-link">spanishoddata</a></span><span class="op">)</span></span></code></pre></div>
<p>Local development: to load the package locally, clone it and navigate to the root of the package in the terminal, e.g. with the following:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">gh</span> repo clone Robinlovelace/spanishoddata</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="ex">code</span> spanishoddata</span></code></pre></div>
<p>Then run the following command from the R console:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="setting-the-data-directory">Setting the data directory<a class="anchor" aria-label="anchor" href="#setting-the-data-directory"></a>
</h1>
<p>You can specify the data directory globally by setting the <code>SPANISH_OD_DATA_DIR</code> environment variable, e.g. with the following command:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">edit_r_environ</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Then set the data directory globally, by typing this line in the file:</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>SPANISH_OD_DATA_DIR <span class="ot">=</span> <span class="st">"/path/to/data"</span></span></code></pre></div>
<p>You can also set the data directory locally or on a per session basis as described below.</p>
<details><p>Set the ‘envar’ in the working directory by editing <code>.Renviron</code> file in the root of the project:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/file.edit.html" class="external-link">file.edit</a></span><span class="op">(</span><span class="st">".Renviron"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, you can set the data directory in the current R session as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>SPANISH_OD_DATA_DIR <span class="op">=</span> <span class="st">"/path/to/data"</span><span class="op">)</span></span></code></pre></div>
</details>
</div>
<div class="section level1">
<h1 id="using-the-package">Using the package<a class="anchor" aria-label="anchor" href="#using-the-package"></a>
</h1>
<p>To run the code in this README, we will use the following setup:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Get metadata for the datasets as follows (we are using version 2 data covering years 2022 and onwards):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/spod_available_data.html">spod_available_data</a></span><span class="op">(</span>ver <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># for version 2 of the data</span></span>
<span><span class="va">metadata</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># A tibble: 9,442 × 6</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>   target_url           pub_ts              file_extension data_ym data_ymd  </span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>   <span class="sc">&lt;</span>chr<span class="sc">&gt;</span>                <span class="er">&lt;</span>dttm<span class="sc">&gt;</span>              <span class="er">&lt;</span>chr<span class="sc">&gt;</span>          <span class="er">&lt;</span>date<span class="sc">&gt;</span>  <span class="er">&lt;</span>date<span class="sc">&gt;</span>    </span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a> <span class="dv">1</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">54</span><span class="sc">:</span><span class="dv">08</span> gz             <span class="cn">NA</span>      <span class="dv">2022-10-23</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a> <span class="dv">2</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">51</span><span class="sc">:</span><span class="dv">07</span> gz             <span class="cn">NA</span>      <span class="dv">2022-10-22</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a> <span class="dv">3</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">47</span><span class="sc">:</span><span class="dv">52</span> gz             <span class="cn">NA</span>      <span class="dv">2022-10-20</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a> <span class="dv">4</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">14</span><span class="sc">:</span><span class="dv">55</span> gz             <span class="cn">NA</span>      <span class="dv">2022-10-18</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a> <span class="dv">5</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">11</span><span class="sc">:</span><span class="dv">58</span> gz             <span class="cn">NA</span>      <span class="dv">2022-10-17</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a> <span class="dv">6</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">09</span><span class="sc">:</span><span class="dv">03</span> gz             <span class="cn">NA</span>      <span class="dv">2022-10-12</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a> <span class="dv">7</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">05</span><span class="sc">:</span><span class="dv">57</span> gz             <span class="cn">NA</span>      <span class="dv">2022-10-07</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a> <span class="dv">8</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">02</span><span class="sc">:</span><span class="dv">12</span> gz             <span class="cn">NA</span>      <span class="dv">2022-08-07</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a> <span class="dv">9</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">09</span><span class="sc">:</span><span class="dv">58</span><span class="sc">:</span><span class="dv">34</span> gz             <span class="cn">NA</span>      <span class="dv">2022-08-06</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="dv">10</span> https<span class="sc">:</span><span class="er">//</span>movilidad<span class="sc">-</span>o… <span class="dv">2024-07-30</span> <span class="dv">09</span><span class="sc">:</span><span class="dv">54</span><span class="sc">:</span><span class="dv">30</span> gz             <span class="cn">NA</span>      <span class="dv">2022-08-05</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co"># ℹ 9,432 more rows</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="co"># ℹ 1 more variable: local_path &lt;chr&gt;</span></span></code></pre></div>
<div class="section level2">
<h2 id="zones">Zones<a class="anchor" aria-label="anchor" href="#zones"></a>
</h2>
<p>Zones can be downloaded as follows:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distritos</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/spod_get_zones.html">spod_get_zones</a></span><span class="op">(</span><span class="st">"distritos"</span>, ver <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">distritos_wgs84</span> <span class="op">&lt;-</span> <span class="va">distritos</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_simplify</a></span><span class="op">(</span>dTolerance <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">distritos_wgs84</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-distritos-1.png"></p>
</div>
<div class="section level2">
<h2 id="od-data">OD data<a class="anchor" aria-label="anchor" href="#od-data"></a>
</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/spod_get_od.html">spod_get_od</a></span><span class="op">(</span></span>
<span>  zones <span class="op">=</span> <span class="st">"distritos"</span>,</span>
<span>  dates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>start <span class="op">=</span> <span class="st">"2024-03-01"</span>, end <span class="op">=</span> <span class="st">"2024-03-07"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">od_db</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"tbl_duckdb_connection"</span> <span class="st">"tbl_dbi"</span>               <span class="st">"tbl_sql"</span>              </span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>[<span class="dv">4</span>] <span class="st">"tbl_lazy"</span>              <span class="st">"tbl"</span>                  </span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">od_db</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a> [<span class="dv">1</span>] <span class="st">"full_date"</span>                   <span class="st">"time_slot"</span>                  </span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a> [<span class="dv">3</span>] <span class="st">"id_origin"</span>                   <span class="st">"id_destination"</span>             </span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a> [<span class="dv">5</span>] <span class="st">"distance"</span>                    <span class="st">"activity_origin"</span>            </span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a> [<span class="dv">7</span>] <span class="st">"activity_destination"</span>        <span class="st">"study_possible_origin"</span>      </span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a> [<span class="dv">9</span>] <span class="st">"study_possible_destination"</span>  <span class="st">"residence_province_ine_code"</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>[<span class="dv">11</span>] <span class="st">"residence_province"</span>          <span class="st">"income"</span>                     </span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>[<span class="dv">13</span>] <span class="st">"age"</span>                         <span class="st">"sex"</span>                        </span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>[<span class="dv">15</span>] <span class="st">"n_trips"</span>                     <span class="st">"trips_total_length_km"</span>      </span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>[<span class="dv">17</span>] <span class="st">"year"</span>                        <span class="st">"month"</span>                      </span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>[<span class="dv">19</span>] <span class="st">"day"</span>                        </span></code></pre></div>
<p>The result is an R database interface object (<code>tbl_dbi</code>) that can be used with dplyr functions and SQL queries ‘lazily’, meaning that the data is not loaded into memory until it is needed. Let’s do an aggregation to find the total number trips per hour over the 7 days:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_per_hour</span> <span class="op">&lt;-</span> <span class="va">od_db</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">full_date</span>, <span class="va">time_slot</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>, Trips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_trips</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Time <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_h</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">full_date</span>, <span class="va">time_slot</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Day <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">wday</a></span><span class="op">(</span><span class="va">Time</span>, label <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n_per_hour</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">Trips</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>colour <span class="op">=</span> <span class="va">Day</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Number of trips per hour over 7 days"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-trips-per-hour-1.png"></p>
<p>The figure above summarises 925,874,012 trips over the 7 days associated with 135,866,524 records.</p>
<p>See how you could do this manually with the following code, highlighting the benefits of the package:</p>
<details><p>Each day in the <code>ficheros-diarios</code> folder contains a file with the following columns:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set timeout for downloads</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">600</span><span class="op">)</span> <span class="co"># 10 minutes</span></span>
<span><span class="va">u1</span> <span class="op">&lt;-</span> <span class="st">"https://movilidad-opendata.mitma.es/estudios_basicos/por-distritos/viajes/ficheros-diarios/2024-03/20240301_Viajes_distritos.csv.gz"</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">u1</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">f1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">u1</span>, <span class="va">f1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">drv</span> <span class="op">&lt;-</span> <span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="st">"daily.duckdb"</span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="va">drv</span><span class="op">)</span></span>
<span><span class="va">od1</span> <span class="op">&lt;-</span> <span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/backend-duckdb.html" class="external-link">tbl_file</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">f1</span><span class="op">)</span></span>
<span><span class="co"># colnames(od1)</span></span>
<span><span class="co">#  [1] "fecha"                   "periodo"</span></span>
<span><span class="co">#  [3] "origen"                  "destino"</span></span>
<span><span class="co">#  [5] "distancia"               "actividad_origen"</span></span>
<span><span class="co">#  [7] "actividad_destino"       "estudio_origen_posible"</span></span>
<span><span class="co">#  [9] "estudio_destino_posible" "residencia"</span></span>
<span><span class="co"># [11] "renta"                   "edad"</span></span>
<span><span class="co"># [13] "sexo"                    "viajes"</span></span>
<span><span class="co"># [15] "viajes_km"</span></span>
<span><span class="va">od1_head</span> <span class="op">&lt;-</span> <span class="va">od1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">od1_head</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="5%">
<col width="4%">
<col width="5%">
<col width="4%">
<col width="5%">
<col width="9%">
<col width="10%">
<col width="12%">
<col width="13%">
<col width="6%">
<col width="3%">
<col width="3%">
<col width="3%">
<col width="4%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="right">fecha</th>
<th align="left">periodo</th>
<th align="left">origen</th>
<th align="left">destino</th>
<th align="left">distancia</th>
<th align="left">actividad_origen</th>
<th align="left">actividad_destino</th>
<th align="left">estudio_origen_posible</th>
<th align="left">estudio_destino_posible</th>
<th align="left">residencia</th>
<th align="left">renta</th>
<th align="left">edad</th>
<th align="left">sexo</th>
<th align="right">viajes</th>
<th align="right">viajes_km</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">20240301</td>
<td align="left">19</td>
<td align="left">01009_AM</td>
<td align="left">01001</td>
<td align="left">0.5-2</td>
<td align="left">frecuente</td>
<td align="left">casa</td>
<td align="left">no</td>
<td align="left">no</td>
<td align="left">01</td>
<td align="left">10-15</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">5.124</td>
<td align="right">6.120</td>
</tr>
<tr class="even">
<td align="right">20240301</td>
<td align="left">15</td>
<td align="left">01002</td>
<td align="left">01001</td>
<td align="left">10-50</td>
<td align="left">frecuente</td>
<td align="left">casa</td>
<td align="left">no</td>
<td align="left">no</td>
<td align="left">01</td>
<td align="left">10-15</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">2.360</td>
<td align="right">100.036</td>
</tr>
<tr class="odd">
<td align="right">20240301</td>
<td align="left">00</td>
<td align="left">01009_AM</td>
<td align="left">01001</td>
<td align="left">10-50</td>
<td align="left">frecuente</td>
<td align="left">casa</td>
<td align="left">no</td>
<td align="left">no</td>
<td align="left">01</td>
<td align="left">10-15</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1.743</td>
<td align="right">22.293</td>
</tr>
<tr class="even">
<td align="right">20240301</td>
<td align="left">05</td>
<td align="left">01009_AM</td>
<td align="left">01001</td>
<td align="left">10-50</td>
<td align="left">frecuente</td>
<td align="left">casa</td>
<td align="left">no</td>
<td align="left">no</td>
<td align="left">01</td>
<td align="left">10-15</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">2.404</td>
<td align="right">24.659</td>
</tr>
<tr class="odd">
<td align="right">20240301</td>
<td align="left">06</td>
<td align="left">01009_AM</td>
<td align="left">01001</td>
<td align="left">10-50</td>
<td align="left">frecuente</td>
<td align="left">casa</td>
<td align="left">no</td>
<td align="left">no</td>
<td align="left">01</td>
<td align="left">10-15</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">5.124</td>
<td align="right">80.118</td>
</tr>
<tr class="even">
<td align="right">20240301</td>
<td align="left">09</td>
<td align="left">01009_AM</td>
<td align="left">01001</td>
<td align="left">10-50</td>
<td align="left">frecuente</td>
<td align="left">casa</td>
<td align="left">no</td>
<td align="left">no</td>
<td align="left">01</td>
<td align="left">10-15</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">7.019</td>
<td align="right">93.938</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
<p>You can get the same result, but for multiple files, as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_multi_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/spod_get.html">spod_get</a></span><span class="op">(</span></span>
<span>  subdir <span class="op">=</span> <span class="st">"estudios_basicos/por-distritos/viajes/ficheros-diarios"</span>,</span>
<span>  date_regex <span class="op">=</span> <span class="st">"2024030[1-7]"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">od_multi_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Source:   SQL [?? x 18]</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="co"># Database: DuckDB v1.0.0 [eugeni@Linux 5.15.0-118-generic:R 4.4.1/:memory:]</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>      fecha periodo origen  destino distancia actividad_origen actividad_destino</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>      <span class="sc">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span>   <span class="er">&lt;</span>chr<span class="sc">&gt;</span>   <span class="er">&lt;</span>chr<span class="sc">&gt;</span>   <span class="er">&lt;</span>chr<span class="sc">&gt;</span>     <span class="er">&lt;</span>chr<span class="sc">&gt;</span>            <span class="er">&lt;</span>chr<span class="sc">&gt;</span>            </span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a> <span class="dv">1</span> <span class="dv">20240307</span> <span class="dv">00</span>      <span class="dv">01009</span>_… <span class="dv">01001</span>   <span class="fl">0.5</span><span class="dv">-2</span>     frecuente        casa             </span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a> <span class="dv">2</span> <span class="dv">20240307</span> <span class="dv">09</span>      <span class="dv">01009</span>_… <span class="dv">01001</span>   <span class="fl">0.5</span><span class="dv">-2</span>     frecuente        casa             </span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a> <span class="dv">3</span> <span class="dv">20240307</span> <span class="dv">18</span>      <span class="dv">01009</span>_… <span class="dv">01001</span>   <span class="fl">0.5</span><span class="dv">-2</span>     frecuente        casa             </span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a> <span class="dv">4</span> <span class="dv">20240307</span> <span class="dv">19</span>      <span class="dv">01009</span>_… <span class="dv">01001</span>   <span class="fl">0.5</span><span class="dv">-2</span>     frecuente        casa             </span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a> <span class="dv">5</span> <span class="dv">20240307</span> <span class="dv">20</span>      <span class="dv">01009</span>_… <span class="dv">01001</span>   <span class="fl">0.5</span><span class="dv">-2</span>     frecuente        casa             </span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a> <span class="dv">6</span> <span class="dv">20240307</span> <span class="dv">14</span>      <span class="dv">01002</span>   <span class="dv">01001</span>   <span class="dv">10-50</span>     frecuente        casa             </span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a> <span class="dv">7</span> <span class="dv">20240307</span> <span class="dv">22</span>      <span class="dv">01002</span>   <span class="dv">01001</span>   <span class="dv">10-50</span>     frecuente        casa             </span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a> <span class="dv">8</span> <span class="dv">20240307</span> <span class="dv">06</span>      <span class="dv">01009</span>_… <span class="dv">01001</span>   <span class="dv">10-50</span>     frecuente        casa             </span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a> <span class="dv">9</span> <span class="dv">20240307</span> <span class="dv">09</span>      <span class="dv">01009</span>_… <span class="dv">01001</span>   <span class="dv">10-50</span>     frecuente        casa             </span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a><span class="dv">10</span> <span class="dv">20240307</span> <span class="dv">11</span>      <span class="dv">01009</span>_… <span class="dv">01001</span>   <span class="dv">10-50</span>     frecuente        casa             </span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="co"># ℹ more rows</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="co"># ℹ 11 more variables: estudio_origen_posible &lt;chr&gt;,</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a><span class="co">#   estudio_destino_posible &lt;chr&gt;, residencia &lt;chr&gt;, renta &lt;chr&gt;, edad &lt;chr&gt;,</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a><span class="co">#   sexo &lt;chr&gt;, viajes &lt;dbl&gt;, viajes_km &lt;dbl&gt;, day &lt;dbl&gt;, month &lt;dbl&gt;,</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="co">#   year &lt;dbl&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">od_multi_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"tbl_duckdb_connection"</span> <span class="st">"tbl_dbi"</span>               <span class="st">"tbl_sql"</span>              </span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>[<span class="dv">4</span>] <span class="st">"tbl_lazy"</span>              <span class="st">"tbl"</span>                  </span></code></pre></div>
</details>
</div>
</div>
<div class="section level1">
<h1 id="desire-lines">Desire lines<a class="anchor" aria-label="anchor" href="#desire-lines"></a>
</h1>
<p>We’ll use the same input data to pick-out the most important flows in Spain, with a focus on longer trips for visualisation:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_national_aggregated</span> <span class="op">&lt;-</span> <span class="va">od_db</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id_origin</span>, <span class="va">id_destination</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>Trips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_trips</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Trips</span> <span class="op">&gt;</span> <span class="fl">500</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">Trips</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">od_national_aggregated</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># A tibble: 96,404 × 3</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>   id_origin id_destination    Trips</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>   <span class="sc">&lt;</span>fct<span class="sc">&gt;</span>     <span class="er">&lt;</span>fct<span class="sc">&gt;</span>             <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a> <span class="dv">1</span> <span class="dv">2807908</span>   <span class="dv">2807908</span>        <span class="fl">2441404.</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a> <span class="dv">2</span> <span class="dv">0801910</span>   <span class="dv">0801910</span>        <span class="fl">2112188.</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a> <span class="dv">3</span> <span class="dv">0801902</span>   <span class="dv">0801902</span>        <span class="fl">2013618.</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a> <span class="dv">4</span> <span class="dv">2807916</span>   <span class="dv">2807916</span>        <span class="fl">1821504.</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a> <span class="dv">5</span> <span class="dv">2807911</span>   <span class="dv">2807911</span>        <span class="fl">1785981.</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a> <span class="dv">6</span> <span class="dv">04902</span>     <span class="dv">04902</span>          <span class="fl">1690606.</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a> <span class="dv">7</span> <span class="dv">2807913</span>   <span class="dv">2807913</span>        <span class="fl">1504484.</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a> <span class="dv">8</span> <span class="dv">2807910</span>   <span class="dv">2807910</span>        <span class="fl">1299586.</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a> <span class="dv">9</span> <span class="dv">0704004</span>   <span class="dv">0704004</span>        <span class="fl">1287122.</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="dv">10</span> <span class="dv">28106</span>     <span class="dv">28106</span>          <span class="fl">1286058.</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a><span class="co"># ℹ 96,394 more rows</span></span></code></pre></div>
<p>The results show that the largest flows are intra-zonal. Let’s keep only the inter-zonal flows:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_national_interzonal</span> <span class="op">&lt;-</span> <span class="va">od_national_aggregated</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id_origin</span> <span class="op">!=</span> <span class="va">id_destination</span><span class="op">)</span></span></code></pre></div>
<p>We can convert these to geographic data with the {od} package (Lovelace and Morgan 2024):</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_national_sf</span> <span class="op">&lt;-</span> <span class="fu">od</span><span class="fu">::</span><span class="fu">od_to_sf</span><span class="op">(</span></span>
<span>  <span class="va">od_national_interzonal</span>,</span>
<span>  z <span class="op">=</span> <span class="va">distritos_wgs84</span></span>
<span><span class="op">)</span></span>
<span><span class="va">distritos_wgs84</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">spData</span><span class="fu">::</span><span class="va">world</span>, fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="va">Trips</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"blue"</span>, data <span class="op">=</span> <span class="va">od_national_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">5</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">35</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-desire-lines-1.png"></p>
<p>Let’s focus on trips in and around a particular area (Salamanca):</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">salamanca_zones</span> <span class="op">&lt;-</span> <span class="fu">zonebuilder</span><span class="fu">::</span><span class="fu">zb_zone</span><span class="op">(</span><span class="st">"Salamanca"</span><span class="op">)</span></span>
<span><span class="va">distritos_salamanca</span> <span class="op">&lt;-</span> <span class="va">distritos_wgs84</span><span class="op">[</span><span class="va">salamanca_zones</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">distritos_salamanca</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-salamanca-zones-1.png"></p>
<p>We will use this information to subset the rows, to capture all movement within the study area:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids_salamanca</span> <span class="op">&lt;-</span> <span class="va">distritos_salamanca</span><span class="op">$</span><span class="va">id</span></span>
<span><span class="va">od_salamanca</span> <span class="op">&lt;-</span> <span class="va">od_national_sf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id_origin</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_salamanca</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id_destination</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_salamanca</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">Trips</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot the results:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_salamanca_sf</span> <span class="op">&lt;-</span> <span class="fu">od</span><span class="fu">::</span><span class="fu">od_to_sf</span><span class="op">(</span></span>
<span>  <span class="va">od_salamanca</span>,</span>
<span>  z <span class="op">=</span> <span class="va">distritos_salamanca</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey"</span>, data <span class="op">=</span> <span class="va">distritos_salamanca</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>colour <span class="op">=</span> <span class="va">Trips</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">od_salamanca_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-salamanca-plot-1.png"></p>
</div>
<div class="section level1">
<h1 id="further-information">Further information<a class="anchor" aria-label="anchor" href="#further-information"></a>
</h1>
<p>For more information on the package, see:</p>
<ul>
<li>The <a href="https://robinlovelace.github.io/spanishoddata/" class="external-link">pkgdown site</a>
<ul>
<li>Information on the <a href="https://robinlovelace.github.io/spanishoddata/reference/index.html" class="external-link">functions</a>
</li>
<li>The <a href="https://robinlovelace.github.io/spanishoddata/articles/work-with-v1-data.html" class="external-link">v1 vs v2 vignette</a> which explains the differences between the two versions of the data</li>
<li>The <a href="https://robinlovelace.github.io/spanishoddata/articles/uses.html" class="external-link">uses vignette</a> which documents use cases</li>
</ul>
</li>
</ul>
</div>
<div class="section level1">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h1>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-lovelace_od_2024" class="csl-entry">
Lovelace, Robin, and Malcolm Morgan. 2024. “Od: Manipulate and Map Origin-Destination Data,” August. <a href="https://cran.r-project.org/web/packages/od/od.pdf" class="external-link uri">https://cran.r-project.org/web/packages/od/od.pdf</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/Robinlovelace/spanishoddata/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/Robinlovelace/spanishoddata/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing spanishoddata</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Egor Kotov <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-6690-5345" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Robin Lovelace <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0001-5679-6536" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/Robinlovelace/spanish_od_data/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/Robinlovelace/spanish_od_data/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Egor Kotov, Robin Lovelace.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
